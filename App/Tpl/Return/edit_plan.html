<link type="text/css" rel="stylesheet" href="__PUBLIC__/css/validator.css"/>
<script type="text/javascript" src="__PUBLIC__/js/checkuser.js"></script>
<style>
    .close{font-size:34px;font-weight:400;color:#fff;}
    .close:hover{color:#fff;}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{
        -webkit-appearance:textfield;
    }
    input[type="number"]{
        -moz-appearance:textfield;
    }
</style>
<div class="modal-header" style="padding:3px 10px;">
    <b style="font-size:16px;">回款计划详情</b>
    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body clearfix">
    <form id="ad_Form" class="form-horizontal m-t" method="post">
        <div id="planshow" class="col-md-12" style="display: block;">
            <input type="hidden" name="business_id" value="{$business.business_id}"/>
            <input type="hidden" name="nums" value="{$plan.nums}">
            <input id="add_nums" type="hidden" name="add_nums" value="">
            <table class="table form-inline" >
                <tr>
                    <th colspan="2"><span class="fa fa-th-list">&nbsp;项目回款详细信息</span></th>
                </tr>
                <tr>
                    <td class="col-md-2">对应客户:</td>
                    <td class="col-md-4">{$plan.customer}</td>
                    <td class="col-md-2">负责人:</td>
                    <td class="col-md-4">{$business.user_name}</td>
                </tr>
                <tr>
                    <td>对应合同:</td>
                    <td>{$plan.business}</td>
                    <td>所属部门:</td>
                    <td>{$business.department_name}</td>
                </tr>
                <tr >
                    <td></td>
                </tr>
                <tr>
                    <td>回款期次:</td>
                    <td>{$plan.nums}</td>
                    <td>计划回款总金额:</td>
                    <td>{$plan.total}</td>
                </tr>
                <tr >
                    <td>实际回收期次:</td>
                    <td>0</td>
                    <td>已回款:</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>当前期次:</td>
                    <td>0</td>
                    <td>实际回款状态:</td>
                    <td>逾期未完成</td>
                </tr>
            </table>
            <table class="table">
                <tr><td></td></tr>
                <tr>
                    <th>回款期次</th>
                    <th>期次计划回款金额</th>
                    <th>所占比例</th>
                    <th>计划时间</th>
                    <th>已回款</th>
                    <th>回款状态</th>
                    <th>付款方式</th>
                    <th>回款时间</th>
                    <th>备注</th>
                </tr>
                <volist name="periods" id="vo">
                    <tr>
                        <th>{$vo.num}</th>
                        <th>{$vo.money}</th>
                        <th>{$vo.property}</th>
                        <th>2015</th>
                        <th>已回款</th>
                        <th>{$vo.status}</th>
                        <th>付款方式</th>
                        <th>回款时间</th>
                        <th>{$vo.remark}</th>
                    </tr>
                </volist>
            </table>
        </div>
        <div id="planedit" class="col-md-12" style="display: none;">
            <input type="hidden" name="plan_id" value="{$plan.Id}"/>
            <table class="table form-inline" >
                <tr>
                    <th colspan="2"><span class="fa fa-th-list">&nbsp;项目回款详细信息</span></th>
                </tr>
                <tr>
                    <td>对应项目:</td>
                    <td>
                        <select id="contract" class="form-control checkit" rel="require" rell="合同" name="contract" onchange="contractChanged();">
                            <option value=" ">--对应项目--</option>
                            <volist name="business_all" id="vo">
                                <option value="{$vo['business_id']}">{$vo['name']}</option>
                            </volist>
                        </select>
                        <!--<input id="contract" class="form-control checkit" rel="require" rell="合同" name="contract">-->
                        <div class="error_msg" id="contractTip"></div>
                    </td>
                    <td class="col-md-2">负责人:</td>
                    <td class="col-md-4">
                        <select id="person" name="person" class="form-control checkit" rel="require" rell="负责人" onchange="personChanged();">
                            <option value=" ">--负责人--</option>
                            <volist name="user" id="vo">
                                <option value="{$vo.user_id}">{$vo.name}</option>
                            </volist>
                        </select>
                        <!--<input id="person" class="form-control checkit" rel="require" rell="负责人" name="person">-->
                        <div class="error_msg" id="personTip"></div>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-2">对应客户:</td>
                    <td class="col-md-4">
                        <input id="customer" class="form-control" readonly="readonly"  name="customer">
                    </td>
                    <td>所属部门:</td>
                    <td>
                        <input id="dename" class="form-control" readonly="readonly" name="department">
                    </td>
                </tr>
                <tr >
                    <td></td>
                </tr>
                <tr>
                    <td>回款期次:</td>
                    <td id="nums">{$plan.nums}</td>
                    <td>计划回款总金额:</td>
                    <td><input id="total" class="form-control checkit" rel="require" rell="客户" name="total"><div class="error_msg" id="totalTip"></div></td>
                </tr>
                <tr>
                    <td>当前期次:</td>
                    <td>0</td>
                    <td>实际回款状态:</td>
                    <td>逾期未完成</td>
                </tr>
            </table>
            <table class="table" id="tlast">
                <tr><td></td></tr>
                <tr>
                    <th></th><th></th>
                    <th>回款期次</th>
                    <th>期次计划回款金额</th>
                    <th>所占比例</th>
                    <th>计划时间</th>
                    <th>备注</th>
                </tr>
                <volist name="periods" id="vo">
                    <tr>
                        <td><button onclick="minusedit('{$vo.plan_id}','{$vo.Id}',this);" type="button" class="btn btn-white">-</button></td>
                        <td><button onclick="addedit();" type="button" class="btn btn-white">+</button></td>
                        <th>{$vo.num}</th>
                        <th>{$vo.money}</th>
                        <th>{$vo.property}</th>
                        <th>2015</th>
                        <th>{$vo.remark}</th>
                    </tr>
                </volist>
            </table>
        </div>
    </form>
</div>
<script>
    function personChanged() {
        var person = $("#person").val();
        $.ajax({
            type: "post",
            async:false,
            url: "{:U('return/personChanged')}",
            data: {person_id:person},
            dataType: "json",
            success : function(result){
                $("#dename").val(result);
            }
        });
    }
    function contractChanged() {
        var bvalue = $("#contract").val();
        $.ajax({
            type: "post",
            async:false,
            url: "{:U('return/contractChanged')}",
            data: {business_id:bvalue},
            dataType: "json",
            success : function(result){
                $("#customer").val(result.customer_name);
            }
        });
    }

    var num = $("#nums").html();
    function minusedit(obj,pid,obj1) {
        if(obj1 == undefined){
            $("#tlast").children().last().remove();
            num--;
            $("#add_nums").val(num);
        }
        else {
            swal({
                    title: "您确定要删除当前期次信息吗？",
                    text: "删除后将无法恢复，请谨慎操作！",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "是的，我要删除！",
                    cancelButtonText:'让我再考虑一下…',
                    closeOnConfirm:false,
                    closeOnCancel:false
                },
                function(isConfirm){
                    if (isConfirm) {
                        $.ajax({
                            url:"/index.php?m=return&a=delete",
                            type:"post",
                            async:true,
                            data:{ plan_id:obj,
                                period_id :pid,
                            },
                            success: function (data) {
                                if (data.status == 1) {
                                    swal({
                                        title:'删除成功',
                                        text:'您已经永久删除该条信息！',
                                        type:"success",
                                        confirmButtonText: "确定"
                                    },function (isConfirm) {
                                        if(isConfirm){
                                            location.reload();
                                        }
                                    });
                                } else {
                                    swal({
                                        title: "操作失败！",
                                        text:data.info,
                                        type: "error"
                                    })
                                    return false;
                                }
                            },
                            dataType: 'json'
                        });
                    } else {
                        swal("已取消","您取消了删除操作！","error");
                    }
                });
        };
        return false;
    }
    function addedit() {
        num++;
        $("#tlast").children().last().after("<tr><td><button onclick='minusedit();' type='button' class='btn btn-white'>-</button></td>" +
            "<td><button onclick='addedit();' type='button' class='btn btn-white'>+</button></td>" +
            "<th><input name='num"+num+"' type='hidden' readonly='readonly' style='width:90%;' value='"+num+"'>"+num+"</th>" +
            "<th><input name='money"+num+"' type='number'style='width:90%;' ></th>" +
            "<th><input name='property"+num+"' type='text' readonly='readonly' style='width:90%;'></th>" +
            "<th><input name='time"+num+"' type='date' style='width:90%;'></th>" +
            "<th><input name='remark"+num+"' type='text' style='width:100%;'></th></tr>");
        $("#add_nums").val(num);
    }
    $(document).ready(function(){
        $("#edit").click(function () {
            $("#bianji").css('display','none');
            $("#baocun").css('display','block');
            $("#planedit").css('display','block');
            $("#planshow").css('display','none');
        });
        $("#back").click(function () {
            $("#baocun").css('display','none');
            $("#bianji").css('display','block');
            $("#planedit").css('display','none');
            $("#planshow").css('display','block');
        });
        $("#adbtn").click(function(){
            var bname = $("#business option:selected").html();
            $("#businessname").val(bname);
            if(input_msg && before_submit()){
                $.ajax({
                    type: "POST",
                    url: "{:U('plan_edit')}",
                    data:$("#ad_Form").serialize(),
                    async: true,
                    success: function(data) {
                        if(data.status == 1){
                            swal({
                                title: "添加成功！",
                                text: "跳转中!",
                                type: "success"
                            });
                            $('#Modal').modal('hide');
                            top.location.reload();
                        }else{
                            swal({
                                title: "添加失败!",
                                text: data.info,
                                type: "error"
                            });
                        }
                    }
                });
            }else{
                var item_id = [];
                $('.checkit').each(function(k,v){
                    checkform(v);
                    item_id.push($(v).attr('id'));
                });
                $.each(item_id,function(k,v){
                    if($('#'+v+'Tip').html() == ''){
                        item_id.splice(k,1);
                    }
                });
                $('#'+item_id[0]).focus();
                return false;
            }
        });
    });
</script>
<div id="baocun" class="modal-footer" style="padding:8px 22px;display: none;">
    <button type="submit" id="adbtn" class="btn btn-primary">保存</button>
    <button type="button" id="back" class="btn btn-white" >取消</button>
</div>
<div id="bianji" class="modal-footer" style="padding:8px 22px;display: block;">
    <button type="button" id="edit" class="btn btn-primary">编辑</button>
    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
</div>
